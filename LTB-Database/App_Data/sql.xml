<?xml version="1.0" encoding="UTF-8"?>
<sqlMap>
	<select id="liveSearch" class="">
		<![CDATA[
		(
			SELECT DISTINCT 
				name
			FROM 
				ltbdb_books 
			WHERE 
				name LIKE #term#
		)
		UNION DISTINCT
		(
			SELECT DISTINCT 
				name
			FROM 
				ltbdb_stories 
			WHERE 
				name LIKE #term#
		) 
		ORDER BY name
		]]>
	</select>
	<select id="searchBook" class="">
		SELECT distinct
			b.bookid as id, 
			b.name as name, 
			b.number as number,
			b.catid as catid,
			b.image as image,
			b.added as added,
			(
				select 
					c.name 
				from 
					ltbdb_categories c 
				where 
					c.catid = b.catid
			) as category 
		FROM 
			ltbdb_books b, 
			ltbdb_stories s 
		WHERE 
			b.name LIKE #term#
			OR 
			(
				b.number = #term#
				and #term# REGEXP '^[0-9]+'
			)
			OR
			(
				s.name LIKE #term# 
				AND b.bookid = s.bookid
			)
		ORDER BY 
			b.number ASC
		LIMIT 
			#items# OFFSET #page#
	</select>
	<select id="getBookCount" class="">
		select 
			count(*) as count	
		from 
			ltbdb_books
	</select>
	<select id="getBookCountForCategory" class="">
		select 
			count(*) as count	
		from 
			ltbdb_books 
		where 
			catid = #catid#
	</select>
	<select id="getBookCountForSearch" class="">
		SELECT 
			count(distinct b.name) as count
		FROM 
			ltbdb_books b, 
			ltbdb_stories s 
		WHERE 
			b.name LIKE #term#
			OR 
			(
				b.number = #term#
				and #term# REGEXP '^[0-9]+'
			)
			OR
			(
				s.name LIKE #term# 
				AND b.bookid = s.bookid
			)
		ORDER BY 
			b.number
	</select>
	<select id="getStoryCount" class="">
		SELECT 
			COUNT(*) as count 
		FROM 
			ltbdb_stories
	</select>
	<select id="getLatestEntries" class="">
		SELECT 
			b.bookid as id, 
			b.name as name, 
			b.number as number, 
			b.catid as catid,
			b.image as image,
			b.added as added,
			(
				select 
					c.name 
				from 
					ltbdb_categories c 
				where 
					c.catid = b.catid
			) as category 
		FROM 
			ltbdb_books b
		ORDER BY 
			b.added DESC LIMIT 6
	</select>
	<select id="getBooks" class="">
		SELECT 
			b.bookid as id, 
			b.name as name, 
			b.number as number,
			b.catid as catid,
			b.image as image,
			b.added as added,
			(
				select 
					c.name 
				from 
					ltbdb_categories c 
				where 
					c.catid = b.catid
			) as category 
		FROM 
			ltbdb_books b
		ORDER BY 
			number ASC 
		LIMIT 
			#items# OFFSET #page#
	</select>
	<select id="getAllBooks" class="">
		SELECT
			b.bookid as id,
			b.name as name,
			b.number as number,
			b.catid as catid,
			b.image as image,
			b.added as added,
			(
				select
					c.name
				from
					ltbdb_categories c
				where
					c.catid = b.catid
			) as category
		FROM
			ltbdb_books b
		ORDER BY
			number ASC
	</select>
	<select id="getCategories" class="">
		SELECT 
			catid as id, 
			name as name
		FROM 
			ltbdb_categories 
		ORDER BY name ASC
	</select>
	<select id="getCategory" class="">
		SELECT 
			catid as id, 
			name as name
		FROM 
			ltbdb_categories 
		WHERE catid = #catid#
	</select>
	<select id="getBooksFromCategory" class="">
		select 
			b.bookid as id,
			b.name as name,
			b.number as number,
			b.catid as catid,
			b.image as image,
			b.added as added,
			(
				select 
					c.name
				from
					ltbdb_categories c
				where
					c.catid = b.catid
			) as category
		from
			ltbdb_books b
		WHERE
			b.catid = #catid#
		ORDER BY 
			b.number ASC 
		LIMIT #items# OFFSET #page#
	</select>
	<select id="getBook" class="">
		select 
			b.bookid as id, 
			b.name as name, 
			b.number as number, 
			b.catid as catid, 
			b.image as image, 
			b.added as added, 
			(
				select 
					c.name 
				from 
					ltbdb_categories c 
				where 
					c.catid = b.catid
			) as category 
		from 
			ltbdb_books b 
		where 
			b.bookid = #id#
	</select>
	<insert id="insertBook" class="">
		INSERT INTO ltbdb_books 
		(
			name, 
			number, 
			catid, 
			image,
			added
		) 
		VALUES
		(
			#name#, 
			#number#, 
			#catid#, 
			null,
			now()
		)
	</insert>
	<update id="updateBook" class="">
		UPDATE 
			ltbdb_books 
		SET 
			name = #name#, 
			number = #number#, 
			catid = #catid# 
		WHERE 
			bookid = #bookid#
	</update>
	<delete id="deleteBook" class="">
		DELETE FROM 
			ltbdb_books 
		WHERE 
			bookid = #id#;
	</delete>
	<select id="getStories" class="">
		SELECT 
			storyid as id,
			name as name,
			bookid as bookid
		FROM 
			ltbdb_stories 
		WHERE 
			bookid = #id#
		ORDER BY 
			storyid ASC
	</select>
	<select id="getAllStories" class="">
		SELECT
			storyid as id,
			name as name,
			bookid as bookid
		FROM
			ltbdb_stories
		ORDER BY
			storyid ASC
	</select>
	<select id="getStory" class="">
		SELECT
			storyid as id,
			name as name,
			bookid as bookid
		FROM
			ltbdb_stories
		WHERE
			storyid = #storyid#
	</select>
	<insert id="insertStory" class="">
		INSERT INTO ltbdb_stories 
		(
			name, 
			bookid
		) 
		VALUES
		(
			#name#,
			#bookid#
		)
	</insert>
	<delete id="deleteStories" class="">
		DELETE FROM 
			ltbdb_stories 
		WHERE 
			bookid = #bookid#
	</delete>
	<insert id="insertCategory" class="">
		INSERT INTO ltbdb_categories 
		(
			name
		) 
		VALUE
		(
			#name#
		)
	</insert>
	<update id="updateCategory" class="">
		UPDATE 
			ltbdb_categories 
		SET 
			name = #name# 
		WHERE 
			catid = #id#
	</update>
	<delete id="deleteCategory" class="">
		DELETE FROM 
			ltbdb_categories 
		WHERE 
			catid = #id#
	</delete>
	<update id="updateBookImage" class="">
		UPDATE 
			ltbdb_books 
		SET 
			image = #image# 
		WHERE 
			bookid = #id#
	</update>
	<select id="getLastInsertId" class="">
		select last_insert_id()
	</select>
</sqlMap>